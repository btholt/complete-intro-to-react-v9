{"pageProps":{"post":{"attributes":{"title":"use and Suspense","description":"Explore React Suspense and the new 'use' hook in React 19, alongside TanStack Query integration, to manage component rendering and data loading seamlessly. Learn how to implement Suspense to improve code readability and handling of async operations in React applications, guided by seasoned developer Brian Holt.","keywords":["React Suspense","use hook","TanStack Query","React 19","async rendering"]},"html":"<h2>use and Suspense</h2>\n<p>We&#39;ve been talking about React Suspense for a long time, and technically still we are not suppose to use it directly. But we React 19 we will get some blessed ways to start using it. (Some libraries already use it.)</p>\n<p>The idea behind Suspense is that a React component can start rendering and then suspend itself if all its data hasn&#39;t loaded yet. This is cool because your code reads really well: it basically looks like you&#39;re assuming the data is already there, and React takes care of getting it behind the scene.</p>\n<p>This is what the idea of the new <code>use</code> hook is from React. You say <code>use(myPromise)</code> and the React component will only render once myPromise has rendered.</p>\n<p>Luckily TanStack Query already has a few ways of doing this, so we&#39;re going to use that. But just know that <code>use</code> works with any promise, not just TanStack Query.</p>\n<p>First open App.jsx, we have to enable the experimental support for this in TanStack Query (you may not need to this in the future.)</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-comment\">// replace queryClient</span>\n<span class=\"hljs-keyword\">const</span> queryClient = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">QueryClient</span>({\n  <span class=\"hljs-attr\">defaultOptions</span>: {\n    <span class=\"hljs-attr\">queries</span>: {\n      <span class=\"hljs-attr\">experimental_prefetchInRender</span>: <span class=\"hljs-literal\">true</span>,\n    },\n  },\n});\n</code></pre><p>Now in past.lazy.jsx, we need to do some refactoring.</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Suspense</span>, useState, use } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;react&quot;</span>; <span class=\"hljs-comment\">// import Suspense and use</span>\n\n<span class=\"hljs-comment\">// move query and page hooks to ErrorBoundary component</span>\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">ErrorBoundaryWrappedPastOrderRoutes</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">const</span> [page, setPage] = <span class=\"hljs-title function_\">useState</span>(<span class=\"hljs-number\">1</span>);\n  <span class=\"hljs-keyword\">const</span> loadedPromise = <span class=\"hljs-title function_\">useQuery</span>({\n    <span class=\"hljs-attr\">queryKey</span>: [<span class=\"hljs-string\">&quot;past-orders&quot;</span>, page],\n    <span class=\"hljs-attr\">queryFn</span>: <span class=\"hljs-function\">() =&gt;</span> <span class=\"hljs-title function_\">getPastOrders</span>(page),\n    <span class=\"hljs-attr\">staleTime</span>: <span class=\"hljs-number\">30000</span>,\n  }).<span class=\"hljs-property\">promise</span>;\n  <span class=\"hljs-keyword\">return</span> (\n    <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">ErrorBoundary</span>&gt;</span>\n      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Suspense</span>\n        <span class=\"hljs-attr\">fallback</span>=<span class=\"hljs-string\">{</span>\n          &lt;<span class=\"hljs-attr\">div</span> <span class=\"hljs-attr\">className</span>=<span class=\"hljs-string\">&quot;past-orders&quot;</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h2</span>&gt;</span>Loading Past Orders ‚Ä¶<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h2</span>&gt;</span>\n          <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span>\n        }\n      &gt;\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">PastOrdersRoute</span>\n          <span class=\"hljs-attr\">loadedPromise</span>=<span class=\"hljs-string\">{loadedPromise}</span>\n          <span class=\"hljs-attr\">page</span>=<span class=\"hljs-string\">{page}</span>\n          <span class=\"hljs-attr\">setPage</span>=<span class=\"hljs-string\">{setPage}</span>\n        /&gt;</span>\n      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Suspense</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">ErrorBoundary</span>&gt;</span></span>\n  );\n}\n\n<span class=\"hljs-comment\">// first line in PastOrderRoute</span>\n<span class=\"hljs-keyword\">const</span> data = <span class=\"hljs-title function_\">use</span>(loadedPromise);\n<span class=\"hljs-comment\">// also, we had to remove the useQuery call to getPastOrders (with an S), and the related if (isLoading) return statement</span>\n</code></pre><ul>\n<li>We use Suspense to tell React where to pause rendering until <em>everything</em> in it has resolved. If you have several things that suspend, this won&#39;t render until they all complete.</li>\n<li>fallback tells it what to render while it&#39;s suspended</li>\n<li>We need to query inside the parent component (and thus keep track of the page too) because the promise needs to exist outside of the component that is getting suspended. Otherwise it&#39;d be freshly called every single your component rendered. Similar to error boundaries.</li>\n<li>We shoved everything in our error boundary wrapping component. This should probably be renamed.</li>\n<li>Again, we&#39;re using TanStack Query&#39;s support for this, but it could be any promise. TanStack Query just made it easy.</li>\n<li>TanStack Query <a href=\"https://tanstack.com/query/v5/docs/framework/react/guides/suspense\">has several other ways of doing Suspense</a>. We just wanted to try the <code>use</code> hook.</li>\n<li><a href=\"https://react.dev/reference/react/use\">use</a> has a few other uses. Check it out in the docs.</li>\n<li>Unlike most hooks, use, can be used in conditionals and for loops. Kinda weird given most of the rules around hooks, but still true.</li>\n</ul>\n<blockquote>\n<p>üèÅ <a href=\"https://github.com/btholt/citr-v9-project/tree/master/16-use\">Click here to see the state of the project up until now: 16-use</a></p>\n</blockquote>\n","markdown":"\n## use and Suspense\n\nWe've been talking about React Suspense for a long time, and technically still we are not suppose to use it directly. But we React 19 we will get some blessed ways to start using it. (Some libraries already use it.)\n\nThe idea behind Suspense is that a React component can start rendering and then suspend itself if all its data hasn't loaded yet. This is cool because your code reads really well: it basically looks like you're assuming the data is already there, and React takes care of getting it behind the scene.\n\nThis is what the idea of the new `use` hook is from React. You say `use(myPromise)` and the React component will only render once myPromise has rendered.\n\nLuckily TanStack Query already has a few ways of doing this, so we're going to use that. But just know that `use` works with any promise, not just TanStack Query.\n\nFirst open App.jsx, we have to enable the experimental support for this in TanStack Query (you may not need to this in the future.)\n\n```javascript\n// replace queryClient\nconst queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      experimental_prefetchInRender: true,\n    },\n  },\n});\n```\n\nNow in past.lazy.jsx, we need to do some refactoring.\n\n```javascript\nimport { Suspense, useState, use } from \"react\"; // import Suspense and use\n\n// move query and page hooks to ErrorBoundary component\nfunction ErrorBoundaryWrappedPastOrderRoutes() {\n  const [page, setPage] = useState(1);\n  const loadedPromise = useQuery({\n    queryKey: [\"past-orders\", page],\n    queryFn: () => getPastOrders(page),\n    staleTime: 30000,\n  }).promise;\n  return (\n    <ErrorBoundary>\n      <Suspense\n        fallback={\n          <div className=\"past-orders\">\n            <h2>Loading Past Orders ‚Ä¶</h2>\n          </div>\n        }\n      >\n        <PastOrdersRoute\n          loadedPromise={loadedPromise}\n          page={page}\n          setPage={setPage}\n        />\n      </Suspense>\n    </ErrorBoundary>\n  );\n}\n\n// first line in PastOrderRoute\nconst data = use(loadedPromise);\n// also, we had to remove the useQuery call to getPastOrders (with an S), and the related if (isLoading) return statement\n```\n\n- We use Suspense to tell React where to pause rendering until _everything_ in it has resolved. If you have several things that suspend, this won't render until they all complete.\n- fallback tells it what to render while it's suspended\n- We need to query inside the parent component (and thus keep track of the page too) because the promise needs to exist outside of the component that is getting suspended. Otherwise it'd be freshly called every single your component rendered. Similar to error boundaries.\n- We shoved everything in our error boundary wrapping component. This should probably be renamed.\n- Again, we're using TanStack Query's support for this, but it could be any promise. TanStack Query just made it easy.\n- TanStack Query [has several other ways of doing Suspense][tsq-suspense]. We just wanted to try the `use` hook.\n- [use][use] has a few other uses. Check it out in the docs.\n- Unlike most hooks, use, can be used in conditionals and for loops. Kinda weird given most of the rules around hooks, but still true.\n\n> üèÅ [Click here to see the state of the project up until now: 16-use][step]\n\n[step]: https://github.com/btholt/citr-v9-project/tree/master/16-use\n[tsq-suspense]: https://tanstack.com/query/v5/docs/framework/react/guides/suspense\n[use]: https://react.dev/reference/react/use\n","slug":"use-and-suspense","title":"use and Suspense","section":"Whats Next","icon":"shuttle-space","filePath":"/home/runner/work/complete-intro-to-react-v9/complete-intro-to-react-v9/lessons/08-whats-next/C-use-and-suspense.md","nextSlug":"/lessons/whats-next/react-compiler","prevSlug":"/lessons/whats-next/form-actions"}},"__N_SSG":true}